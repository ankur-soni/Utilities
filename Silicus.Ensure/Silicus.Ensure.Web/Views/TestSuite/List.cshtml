@using Kendo.Mvc.UI;

@{
    ViewBag.Title = "TestSuite List";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row white-bg header-row">
    <nav class="" role="navigation" style="margin-bottom: 0">
        <div class="navbar-header">
            <a class="navbar-minimalize minimalize-styl-2 btn btn-primary" id="menu-toggle" style="margin-left:15px;border-radius:0px;" href="#"><i class="fa fa-bars"></i> </a>
        </div>
    </nav>

    <div class="col-lg-10 col-md-10 col-sm-10">
        <h1 class="dashboard-name">Test Suite</h1>
    </div>
</div>

<div class="row">
    <div class="col-sm-12">
        <div class="box M-T15">
            <div class="fluid">

                <div class="row">
                    <div class="alert alert-success" id="messageDiv" style="display:none">
                        <span id="messageContent">This alert box could indicate successful action.</span>
                    </div>
                </div>

                <div class="toolbar">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="col-sm-5 col-md-4 col-lg-3 M-T15 M-B15">
                                <div class="input-group">
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></span>
                                    <input type="text" class="form-control" id='FieldFilter' placeholder="Search" style="height: 38px;">
                                    <span class="input-group-btn">
                                        <button id="testSuiteSearch" class="btn btn-default" style="border:1px solid #0070B9!important" type="button"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-sm-4 M-B15" style="margin-top:20px;">
                                <a href='/TestSuite/Add?testSuiteId=0' class='k-button k-button-icontext k-grid-add'><span class='k-icon k-add'></span>Add test suite</a>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="kendogrid">

                    <div class="table-responsive">
                        @if (Request.IsAuthenticated)
                        {
                            @(Html.Kendo().Grid<Silicus.Ensure.Web.Models.TestSuiteViewModel>().Name("testSuiteGrids")
                .Columns(columns =>
                  {
                      columns.Bound(p => p.TestSuiteName).Width(100).Title("Test Suite");
                      columns.Bound(p => p.Duration).Width(50);
                      columns.Bound(p => p.PositionName).Width(100).Title("Position");
                      columns.Bound(p => p.PrimaryTagNames).Width(80).Title("Tags");
                      columns.Bound(p => p.StatusName).Width(50).Title("Status");
                      columns.Bound("").ClientTemplate(@"<a id='testSuiteDel' class='k-button k-button-icontext k-grid-delete M-T3' href='\\#' onclick='return deleteTestSuite(#=TestSuiteId#)'><span class='k-icon k-delete'></span>Delete</a>" +
                                                            "<a class='k-button k-button-icontext k-grid-edit M-T3' href='" + Url.Action("Add", "TestSuite") + "?testSuiteId=#=TestSuiteId#'><span class='k-icon k-edit'></span>Edit</a>").Title("Actions").Width(200).Sortable(false);
                      columns.Bound("").ClientTemplate(@"

                                                        #if (UserInRole){#
                                                            <a class='k-button k-button-icontext k-grid-add M-T3' href='\\#' onclick= getTestSuiteId('#=TestSuiteId#','#=StatusName#') data-toggle='modal' data-target='\\#myModal'><span class='k-icon k-add'></span>Assign Test</a>
                                                        #}#
                                                            <a class='k-button k-button-icontext k-grid-add M-T3' href='" + Url.Action("Copy", "TestSuite") + "?testSuiteId=#=TestSuiteId#'><span class='k-icon k-add'></span>Copy</a>" +
                                                                                                                          "<a class='k-button k-button-icontext k-grid-add' onclick=showTest('#=TestSuiteId#')><span class='k-icon k-add'></span>Preview</a>"
                                                              ).Title("Test Actions").Width(400).Sortable(false);


                      
                  })
                .DataSource(dataSource => dataSource
                  .Ajax()
                  .Model(model =>
                  {
                      model.Id(p => p.TestSuiteId);
                      model.Field(p => p.TestSuiteId).Editable(false);

                  })
                  .Read(read => read.Action("GetTestSuiteDetails", "TestSuite"))
                  .PageSize(10)
                  .ServerOperation(false)
              )
                  .Pageable(p => p.PageSizes(true))
              .Sortable()
                            )
                        }
                    </div>
                </div>

            </div>
        </div>
        <div id="modalConfirmYesNo" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button"
                                class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 id="lblTitleConfirmYesNo" class="modal-title">Confirmation</h4>
                    </div>
                    <div class="modal-body">
                        <p id="lblMsgConfirmYesNo"></p>
                    </div>
                    <div class="modal-footer">
                        <button id="btnYesConfirmYesNo"
                                type="button" class="btn btn-primary">
                            Yes
                        </button>
                        <button id="btnNoConfirmYesNo"
                                type="button" class="btn btn-default">
                            No
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="DivUsers">

        </div>
    </div>
</div>
<script>
    function showTest(id) {
        window.location.href = "/TestSuite/ViewQuestion?TestSuitId=" + id;
    }
    $(document).ready(function () {
        SetNavigationMenuActive('TestSuite');
        $("#messageDiv").hide();
        $("#FieldFilter").keyup(function () {

            var value = $("#FieldFilter").val();
            grid = $("#testSuiteGrids").data("kendoGrid");
            var pageSize = grid.dataSource.pageSize();
            if (value.length >= 1) {
                if (value) {
                    var filter = { logic: "or", filters: [] };
                    filter.filters.push({ field: "TestSuiteName", operator: "contains", value: value });
                    filter.filters.push({ field: "PositionName", operator: "contains", value: value });
                    filter.filters.push({ field: "PrimaryTagNames", operator: "contains", value: value });
                    grid.dataSource.query({ filter: filter });
                    grid.dataSource.sort({ field: "TestSuiteName", dir: "asc" });
                    grid.dataSource.pageSize(pageSize);
                } else {
                    grid.dataSource.filter({});
                }
            }
            else if (value == "")
                grid.dataSource.filter({});
        });
        //Show successful message
        if ('@TempData["IsNewTestSuite"]' == "1") {
            ShowMessage("Tag saved successfully.", 1);
        }
    });

    function deleteTestSuite(testSuiteId) {
        $.when(showConfirmationWindow('Are you sure, you want to delete this record?', '&nbsp;Delete')).then(function (confirmed) {
            if (confirmed) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("Delete", "TestSuite")',
                    data: { testSuiteId: testSuiteId },
                    success: function (returndata) {
                        if (returndata == 1) {
                            $('#testSuiteGrids').data('kendoGrid').dataSource.read();
                            $('#testSuiteGrids').data('kendoGrid').refresh();
                            ShowMessage("Test suite deleted successfully.", 1);
                        }
                        else {
                            ShowMessage("Error occured while delete operation.", 0);
                        }
                    }
                });
            }
        });
    }

    function getTestSuiteId(testSuiteId, statusName) {
        if (statusName != '@Convert.ToString(Silicus.Ensure.Models.Constants.TestSuiteStatus.Pending)') {
            $('#DivUsers').html('');
            $.ajax({
                type: "POST",
                url: '@Url.Action("TestSuiteUserView", "TestSuite")',
                data: { testSuiteId: testSuiteId },
                success: function (returndata) {
                    $('#DivUsers').html(returndata);
                    $("#myModal").modal();
                }
            });
        }
        else {
            alert("Test suite in pending status.");
        }
    }

    $("#testSuiteSearch").click(function (e) {
        e.preventDefault();
        var datasource = $("#testSuiteGrids").data("kendoGrid").dataSource;
        //Clear filters:
        datasource.filter([]);
        $("#FieldFilter").val('');
    });

    function onUserGridsDataBound() {
        try {
            var testSuiteId = $('#testSuiteId').val();
            $.ajax({
                url: "GetUserIdsForTestSuite?testSuiteId=" + testSuiteId,
                success: function (userIds) {
                    if (userIds && userIds.length > 0) {
                        $.each(userIds, function (i, val) {
                            $("input[value='" + userIds[i] + "']").attr('checked', 'checked')
                        });
                    }
                }

            });
        } catch (e) { }
    }
</script>
