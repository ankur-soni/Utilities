@model Silicus.Ensure.Models.DataObjects.Panel
@using Kendo.Mvc.UI;


        <div>

            @if (Request.IsAuthenticated)
            {
                @(Html.Kendo().Grid<Silicus.Ensure.Models.DataObjects.Panel>().Name("PanelGrids")
                          .Events(e => e.Edit("gvPanel_onRowEdit"))
            .DataSource(dataSource => dataSource
            .Ajax()
            .Model(model =>
                    {
                        model.Id(p => p.PanelId);
                        model.Field(p => p.PanelId).Editable(false);

                    })
                     .Read(read => read.Action("GetPanelDetails", "Panel"))
                     .Create(update => update.Action("PanelSave", "Panel"))
                     .Update(update => update.Action("PanelUpdate", "Panel"))
                     .Destroy(delete => delete.Action("PanelDelete", "Panel"))
                     .Events(events => events.Error("error_handler").RequestEnd("requestend_handlerPanel"))
                )
                .Columns(columns =>
                    {
                        columns.Bound(p => p.PanelId).Visible(false).Width(250);
                        columns.Bound(p => p.PanelName).Title("Panel Name").Width(250);
                        columns.Command(command =>
                        {
                            command.Edit();
                            command.Custom("Delete").Click("ConfirmDeleteRow").HtmlAttributes(new { @class = "k-button k-button-icontext k-grid-delete" });
                        }).Title("Actions").Width(160);

                    })
                .Pageable(pager => { pager.PageSizes(true); })
                .Sortable()
                .ToolBar(toolbar =>
                {
                    toolbar.Template(@<text>
                        <div class="toolbar">
                            <div class="row">
                                <div class="col-sm-12 M-B15">
                                    <div class="col-sm-3 M-T15">
                                        <div class="input-group">
                                            <span class="input-group-addon"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></span>
                                            <input type="text" class="form-control" id='PanelFieldFilter' placeholder="Search...">
                                            <span class="input-group-btn">
                                                <button id="postionSearch" class="btn btn-default" type="button" style="height:20px!important;border:1px solid #0070B9!important"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button>
                                            </span>
                                        </div>
                                    </div>
                                    <a href='/Panels/PanelSave' style="margin-top:20px;"  class='k-button k-button-icontext k-grid-add'><span class='k-icon k-add'></span>Add new panel</a>
                                </div>


                                </div>
                        
                        </div>
                    </text>);
                })
                                .Editable(ed => ed.Mode(GridEditMode.InLine))
                )
            }
        </div> 

<script>

    $(document).ready(function () {
        $("#PanelFieldFilter").keyup(function () {

            var value = $("#PanelFieldFilter").val();
            grid = $("#PanelGrids").data("kendoGrid");

            if (value.length > 0) {
                if (value) {
                    grid.dataSource.filter({ field: "PanelName", operator: "contains", value: value });
                    grid.dataSource.sort({ field: "PanelName", dir: "asc" });
                } else {
                    grid.dataSource.filter({});
                }
            }
            else if (value == "")
                grid.dataSource.filter({});
        });

        $("#postionSearch").click(function (e) {
            e.preventDefault();
            var datasource = $("#PanelGrids").data("kendoGrid").dataSource;
            //Clear filters:
            datasource.filter([]);
            $("#PanelFieldFilter").val('');
        });
    });

    (function ($, kendo) {
        $.extend(true, kendo.ui.validator, {
            rules: {
                //define custom validation rule to match remote validation:
                mvcremotevalidation: function (input) {
                    if (input.is("[data-val-remote]") && input.val() != "") {
                        var remoteURL = input.attr("data-val-remote-url");
                        var valid;
                        $.ajax({
                            async: false,
                            type: "POST",
                            url: remoteURL,
                            data: JSON.stringify({ 'PanelName': input.val() }),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (data) {
                                valid = data;
                            }
                        });
                        return valid;

                    }
                    return true;
                }
            },
            messages: {
                mvcremotevalidation: function (input) {
                    return input.attr("data-val-remote");
                }
            }
        });

    })(jQuery, kendo);

    function gvPanel_onRowEdit(e) {
        if (e && e.model && e.model.isNew()) {
            $(".k-grid-update").html('<span><i class="fa fa-save"></i> Save </span>');
        }
    }

    function requestend_handlerPanel(e) {
        if (e.type == "destroy" && !e.response.Errors) {
            //toastr.success("Auto Pays details has been deleted successfully!");
            ShowMessage("Panel deleted successfully.", 1);
            RefreshKendoGrid('PanelGrids');
        }

        if (e.type == "update" && !e.response.Errors) {
            //toastr.success("Auto Pays details has been saved successfully!");
            ShowMessage("Panel Updated successfully.", 1);
            RefreshKendoGrid('PanelGrids');
        }

        if (e.type == "create" && !e.response.Errors) {
            ShowMessage("Panel Created successfully.", 1);
            RefreshKendoGrid('PanelGrids');
        }

    }

    function error_handler(e) {
        ShowMessage(getErrorMessage(e, 0));
    }

    function ConfirmDeleteRow(e) {
        var tr = $(e.target).closest("tr"); //get the row for deletion
        var data = this.dataItem(tr);
        var grid = this;
        $.when(showConfirmationWindow('Are you sure, do you want to delete this record?', 'Delete')).then(function (confirmed) {
            if (confirmed) {
                grid.dataSource.remove(data); grid.dataSource.sync();
            }
        });
    }

</script>
